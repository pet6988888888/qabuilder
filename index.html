import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { ChevronRight, Settings, Play, Plus, X, Trash2, Save, Send, Code, Clipboard, Palette } from 'lucide-react';


// Debounce utility to limit write frequency
const useDebounce = (callback, delay) => {
   const handler = React.useRef(null);
   return useCallback((...args) => {
       if (handler.current) {
           clearTimeout(handler.current);
       }
       handler.current = setTimeout(() => {
           callback(...args);
       }, delay);
   }, [callback, delay]);
};


// Initial Data Structure
const INITIAL_COLORS = {
    bgColor: '#1F2937',
    textColor: '#F3F4F6',
    primaryColor: '#4F46E5',
    primaryHover: '#4338CA',
    accentColor: '#10B981',
};


const INITIAL_QUIZ_DATA = {
   title: "Untitled Transformation Quiz",
   description: "Discover your personalized plan by answering a few quick questions.", // Existing field
   logoUrl: "", // New field for logo
   startId: "q1",
   colors: INITIAL_COLORS,
   questions: {
       "q1": {
           text: "What is your current fitness level?",
           options: [
               { id: "o1", text: "Beginner", next: "q2" },
               { id: "o2", text: "Intermediate", next: "q2" },
               { id: "o3", text: "Advanced", next: "r_pro" }
           ]
       },
       "q2": {
           text: "How many hours a week can you dedicate to training?",
           options: [
               { id: "o4", text: "1-3 hours (Casual)", next: "r_low_effort" },
               { id: "o5", text: "4-6 hours (Moderate)", next: "r_medium" }
           ]
       }
   },
   results: {
       "r_low_effort": {
           title: "Your Sustainable Plan",
           content: "Focus on consistency and diet first. We recommend two 30-minute sessions per week.",
           buttonText: "Get My Quick Start Guide",
           buttonUrl: "https://example.com/quick-start"
       },
       "r_medium": {
           title: "Your Intermediate Plan",
           content: "You are ready for a 4-day split routine focusing on progressive overload.",
           buttonText: "See Intermediate Products",
           buttonUrl: "https://example.com/products/intermediate"
       },
       "r_pro": {
           title: "Your Advanced Optimization Plan",
           content: "We will refine your current routine with periodization and specific recovery techniques.",
           buttonText: "Book a Consultation",
           buttonUrl: "https://example.com/consultation"
       }
   }
};


// Action Button Component
const ActionButton = ({ onClick, children, className = "", icon: Icon, style, onMouseEnter, onMouseLeave }) => (
   <button
       onClick={onClick}
       className={`flex items-center justify-center p-3 text-sm font-semibold rounded-lg shadow-md transition-all duration-200 hover:shadow-lg active:scale-[0.98] ${className}`}
       style={style}
       onMouseEnter={onMouseEnter}
       onMouseLeave={onMouseLeave}
   >
       {Icon && <Icon className="w-5 h-5 mr-2" />}
       {children}
   </button>
);


// Color Picker Component
const ColorPicker = ({ label, value, onChange }) => (
    <div className="flex flex-col space-y-1">
        <label className="text-sm font-medium text-gray-300">{label}</label>
        <div className="flex items-center space-x-2">
            <input
                type="color"
                value={value}
                onChange={(e) => onChange(e.target.value)}
                className="w-8 h-8 rounded-full border-none cursor-pointer p-0 overflow-hidden"
                style={{ backgroundColor: value, outline: 'none' }}
            />
            <input
                type="text"
                value={value}
                onChange={(e) => onChange(e.target.value)}
                className="flex-1 p-2 border border-gray-600 bg-gray-900 text-gray-100 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="#RRGGBB"
            />
        </div>
    </div>
);


// Quiz Player Component
const QuizPlayer = ({ quizData, onReset, availableNodes }) => {
   const [currentId, setCurrentId] = useState(quizData.startId);
   const [answers, setAnswers] = useState([]);
   const [quizState, setQuizState] = useState('intro'); // 'intro', 'quiz', 'result'
   const [userName, setUserName] = useState('');


   const { bgColor, textColor, primaryColor, accentColor, primaryHover } = quizData.colors;


   const currentNode = useMemo(() => {
       if (quizState === 'intro' || !quizData || !quizData.questions || !quizData.results) return null;
       if (currentId.startsWith('q')) {
           return quizData.questions[currentId];
       } else if (currentId.startsWith('r')) {
           return quizData.results[currentId];
       }
       return null;
   }, [currentId, quizData, quizState]);


   const isResultNode = currentId.startsWith('r');


   const handleStartQuiz = () => {
       setQuizState('quiz');
   };


   const handleAnswer = (option) => {
       if (isResultNode) return;
       setAnswers(prev => [...prev, { qId: currentId, optionId: option.id }]);
       setCurrentId(option.next);


       // Check if the next node is a result node (r*) and set the state
       if (option.next.startsWith('r')) {
           setQuizState('result');
       }
   };


   const handleReset = () => {
       setCurrentId(quizData.startId);
       setAnswers([]);
       setUserName('');
       setQuizState('intro');
       onReset();
   };


   // ---------------- INTRO SCREEN ----------------
   if (quizState === 'intro') {
       return (
           <div className="p-8 border rounded-xl shadow-2xl max-w-lg mx-auto" style={{ backgroundColor: bgColor, borderColor: primaryColor }}>
               {quizData.logoUrl && (
                   <img
                       src={quizData.logoUrl}
                       alt="Quiz Logo"
                       className="w-24 h-24 object-contain mx-auto mb-6 rounded-lg shadow-md"
                       onError={(e) => {
                           e.currentTarget.style.display='none';
                           console.error("Failed to load logo image.");
                       }}
                   />
               )}
               <h2 className="text-3xl font-extrabold mb-3 text-center" style={{ color: primaryColor }}>{quizData.title}</h2>
               <p className="mb-6 text-center text-lg" style={{ color: textColor }}>{quizData.description}</p>
               
               <div className="mt-6">
                   <label className="block text-lg font-semibold mb-2" style={{ color: accentColor }}>Your Name (Optional but encouraged):</label>
                   <input
                       type="text"
                       value={userName}
                       onChange={(e) => setUserName(e.target.value)}
                       placeholder="Enter your name"
                       className="w-full p-3 mb-6 border border-gray-600 bg-gray-900 text-gray-100 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                   />
               </div>


               <ActionButton
                   onClick={handleStartQuiz}
                   className="w-full text-white text-lg"
                   style={{ backgroundColor: accentColor }}
                   onMouseEnter={(e) => e.currentTarget.style.backgroundColor = primaryHover}
                   onMouseLeave={(e) => e.currentTarget.style.backgroundColor = accentColor}
                   icon={Play}
               >
                   Start Quiz
               </ActionButton>
           </div>
       );
   }


   // ---------------- ERROR STATE ----------------
   if (!currentNode) {
       return (
           <div className="p-8 text-center bg-gray-800 text-gray-100 rounded-xl shadow-2xl">
               <h2 className="text-2xl font-bold text-red-400 mb-4">Quiz Error</h2>
               <p className="text-gray-400 mb-6">The quiz structure is incomplete or the current step is missing. Please return to Builder Mode.</p>
               <ActionButton onClick={handleReset} className="bg-red-500 text-white hover:bg-red-600">
                   Back to Builder
               </ActionButton>
           </div>
       );
   }




   // ---------------- RESULT SCREEN ----------------
   if (quizState === 'result' || isResultNode) {
       return (
           <div className="p-8 border rounded-xl shadow-2xl max-w-lg mx-auto transform transition-all duration-500" style={{ backgroundColor: bgColor, borderColor: accentColor }}>
               {userName && <h3 className="text-xl font-bold mb-4" style={{ color: primaryColor }}>Hello, {userName}!</h3>}


               <h2 className="text-3xl font-extrabold mb-4 border-b pb-2" style={{ color: accentColor, borderColor: accentColor }}>{currentNode.title}</h2>
               <p className="whitespace-pre-wrap mb-8" style={{ color: textColor }}>{currentNode.content}</p>
               
               <h3 className="text-lg font-semibold mb-3" style={{ color: accentColor }}>Your Journey:</h3>
               <ul className="list-disc list-inside text-sm space-y-1 pl-4" style={{ color: textColor }}>
                   {answers.map((ans, index) => {
                       const question = quizData.questions[ans.qId];
                       const option = question?.options.find(opt => opt.id === ans.optionId);
                       return (
                           <li key={index} className="pl-1">
                               <span className="font-medium" style={{ color: textColor }}>{question?.text || 'Unknown Question'}</span>: {option?.text || 'Unknown Answer'}
                           </li>
                       );
                   })}
               </ul>
               
               {currentNode.buttonUrl && currentNode.buttonText && (
                   <div className="mt-8">
                       <a
                           href={currentNode.buttonUrl}
                           target="_blank"
                           rel="noopener noreferrer"
                           className="flex items-center justify-center p-4 text-lg font-bold rounded-lg shadow-xl transition-all duration-300 w-full"
                           style={{ backgroundColor: accentColor, color: textColor }}
                       >
                           <ChevronRight className="w-6 h-6 mr-2" />
                           {currentNode.buttonText}
                       </a>
                   </div>
               )}
               
               <div className="mt-8 text-center">
                   <ActionButton
                       onClick={handleReset}
                       className="text-white"
                       style={{ backgroundColor: primaryColor }}
                       onMouseEnter={(e) => e.currentTarget.style.backgroundColor = primaryHover}
                       onMouseLeave={(e) => e.currentTarget.style.backgroundColor = primaryColor}
                   >
                       Start New Quiz
                   </ActionButton>
               </div>
           </div>
       );
   }
   
   // ---------------- QUESTION SCREEN ----------------
   return (
       <div className="p-6 border rounded-xl shadow-2xl max-w-md mx-auto transform transition-all duration-300" style={{ backgroundColor: bgColor, borderColor: primaryColor }}>
           <h2 className="text-xl md:text-2xl font-bold mb-6 min-h-[40px]" style={{ color: textColor }}>{currentNode.text}</h2>
           <div className="space-y-3">
               {currentNode.options.map((option) => (
                   <button
                       key={option.id}
                       onClick={() => handleAnswer(option)}
                       className="flex items-center justify-center w-full p-3 text-sm font-semibold rounded-lg shadow-md transition-all duration-200 hover:shadow-lg active:scale-[0.98] text-white"
                       style={{ backgroundColor: primaryColor }}
                       onMouseEnter={(e) => e.currentTarget.style.backgroundColor = primaryHover}
                       onMouseLeave={(e) => e.currentTarget.style.backgroundColor = primaryColor}
                   >
                       <ChevronRight className="w-5 h-5 mr-2" />
                       {option.text}
                       <span className="ml-auto text-xs font-normal opacity-70">
                           {availableNodes[option.next]?.type === 'result' ? ' (Result)' : ' (Next Q)'}
                       </span>
                   </button>
               ))}
           </div>
       </div>
   );
};


// Customization Panel Component
const CustomizationPanel = ({ quizData, setQuizData }) => {
    const handleColorChange = (key, value) => {
        setQuizData(prev => ({
            ...prev,
            colors: {
                ...prev.colors,
                [key]: value
            }
        }));
    };


    return (
        <div className="p-8 bg-gray-800 rounded-xl shadow-2xl border border-gray-700">
            <h3 className="text-2xl font-bold text-indigo-400 mb-6 border-b pb-2 border-gray-700 flex items-center">
                <Palette className="w-6 h-6 mr-3" />
                Customize Quiz Colors
            </h3>
            <p className="text-gray-400 mb-6">These colors will be used in the live Player Mode and in the exported HTML code.</p>
           
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <ColorPicker
                    label="Card Background Color (bgColor)"
                    value={quizData.colors.bgColor}
                    onChange={(v) => handleColorChange('bgColor', v)}
                />
                <ColorPicker
                    label="Text Color (textColor)"
                    value={quizData.colors.textColor}
                    onChange={(v) => handleColorChange('textColor', v)}
                />
                <ColorPicker
                    label="Primary Button Color (primaryColor)"
                    value={quizData.colors.primaryColor}
                    onChange={(v) => handleColorChange('primaryColor', v)}
                />
                <ColorPicker
                    label="Button Hover Color (primaryHover)"
                    value={quizData.colors.primaryHover}
                    onChange={(v) => handleColorChange('primaryHover', v)}
                />
                <ColorPicker
                    label="Accent/CTA Color (accentColor)"
                    value={quizData.colors.accentColor}
                    onChange={(v) => handleColorChange('accentColor', v)}
                />
            </div>
        </div>
    );
};


// Quiz Builder Component
const QuizBuilder = ({ quizData, setQuizData, availableNodes, setEditorMode }) => {
   const [selectedId, setSelectedId] = useState(quizData.startId);
   const [showColorPanel, setShowColorPanel] = useState(false);


   const currentNode = useMemo(() => {
       if (selectedId.startsWith('q')) {
           return quizData.questions[selectedId];
       } else if (selectedId.startsWith('r')) {
           return quizData.results[selectedId];
       }
       return null;
   }, [selectedId, quizData]);


   const isResultNode = selectedId.startsWith('r');
   
   const updateQuizTitle = (e) => {
       setQuizData(prev => ({ ...prev, title: e.target.value }));
   };


   const updateStartId = (e) => {
       setQuizData(prev => ({ ...prev, startId: e.target.value }));
   };


   const updateNode = (field, value) => {
       const typeKey = isResultNode ? 'results' : 'questions';
       setQuizData(prev => ({
           ...prev,
           [typeKey]: {
               ...prev[typeKey],
               [selectedId]: {
                   ...prev[typeKey][selectedId],
                   [field]: value
               }
           }
       }));
   };


   const handleOptionChange = (index, field, value) => {
       if (isResultNode) return;
       const newOptions = [...currentNode.options];
       newOptions[index] = { ...newOptions[index], [field]: value };
       updateNode('options', newOptions);
   };


   const addOption = () => {
       if (isResultNode) return;
       const newId = `o${Date.now()}`;
       updateNode('options', [...currentNode.options, { id: newId, text: `New Option`, next: quizData.startId }]);
   };


   const removeOption = (index) => {
       if (isResultNode) return;
       const newOptions = currentNode.options.filter((_, i) => i !== index);
       updateNode('options', newOptions);
   };


   const addNode = (type) => {
       const prefix = type === 'question' ? 'q' : 'r';
       const newId = `${prefix}${Date.now()}`;
       if (type === 'question') {
           setQuizData(prev => ({
               ...prev,
               questions: {
                   ...prev.questions,
                   [newId]: { text: "New Question Text", options: [{ id: `o${Date.now()}`, text: "Option A", next: prev.startId }] }
               }
           }));
       } else {
           setQuizData(prev => ({
               ...prev,
               results: {
                   ...prev.results,
                   [newId]: {
                       title: "New Result Title",
                       content: "This is a detailed result based on user answers.",
                       buttonText: "",
                       buttonUrl: ""
                   }
               }
           }));
       }
       setSelectedId(newId);
   };


   const deleteNode = (idToDelete) => {
       const typeKey = idToDelete.startsWith('r') ? 'results' : 'questions';


       setQuizData(prev => {
           const newState = { ...prev };
           newState[typeKey] = Object.fromEntries(
               Object.entries(newState[typeKey]).filter(([id]) => id !== idToDelete)
           );


           Object.entries(newState.questions).forEach(([qId, question]) => {
               newState.questions[qId].options = question.options.map(option => ({
                   ...option,
                   next: option.next === idToDelete ? newState.startId : option.next
               }));
           });


           if (idToDelete === selectedId) {
               const remainingIds = Object.keys(newState.questions);
               setSelectedId(remainingIds.length > 0 ? remainingIds[0] : '');
           }
           if (idToDelete === newState.startId) {
               const remainingIds = Object.keys(newState.questions);
               newState.startId = remainingIds.length > 0 ? remainingIds[0] : '';
           }


           return newState;
       });
   };


   const renderNodeList = (nodes, title, type) => (
       <div className="space-y-2">
           <h3 className="text-xs font-bold uppercase tracking-wider text-gray-400">{title}</h3>
           {Object.keys(nodes).map(id => (
               <div
                   key={id}
                   onClick={() => setSelectedId(id)}
                   className={`p-2 rounded-lg text-sm cursor-pointer transition-all flex items-center justify-between
                       ${selectedId === id ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-800 hover:bg-gray-700 text-gray-100'}`}
               >
                   <span className="truncate">
                       {type === 'question' ? nodes[id].text : nodes[id].title}
                   </span>
                   <Trash2
                       className={`w-4 h-4 ml-2 transition-all duration-150 ${selectedId === id ? 'text-indigo-200 hover:text-white' : 'text-gray-400 hover:text-red-500'}`}
                       onClick={(e) => { e.stopPropagation(); deleteNode(id); }}
                   />
               </div>
           ))}
           <ActionButton
               onClick={() => addNode(type)}
               className={`w-full ${type === 'question' ? 'bg-indigo-700 text-white hover:bg-indigo-600' : 'bg-teal-700 text-white hover:bg-teal-600'} text-xs`}
               icon={Plus}
           >
               Add New {type === 'question' ? 'Question' : 'Result'}
           </ActionButton>
       </div>
   );


   const renderNodeDetails = () => {
       if (!currentNode) {
           return <div className="p-8 text-center text-gray-500">Select a Question or Result to edit its content and logic.</div>;
       }


       return (
           <div className="space-y-6">
               <div className="p-4 bg-gray-700 rounded-lg border border-gray-600">
                   <p className="text-xs font-mono text-gray-400 mb-1">ID: {selectedId}</p>
                   {isResultNode ? (
                       <>
                           <label className="block text-sm font-medium text-gray-300 mb-1">Result Title</label>
                           <input
                               type="text"
                               value={currentNode.title}
                               onChange={(e) => updateNode('title', e.target.value)}
                               className="w-full p-2 border border-gray-600 bg-gray-800 text-gray-100 rounded-md focus:ring-teal-500 focus:border-teal-500"
                           />
                           
                           <label className="block text-sm font-medium text-gray-300 mt-4 mb-1">Result Content</label>
                           <textarea
                               value={currentNode.content}
                               onChange={(e) => updateNode('content', e.target.value)}
                               rows="6"
                               className="w-full p-2 border border-gray-600 bg-gray-800 text-gray-100 rounded-md focus:ring-teal-500 focus:border-teal-500 whitespace-pre-wrap"
                           />


                           <h4 className="text-base font-semibold text-teal-400 mt-6 pt-4 border-t border-gray-600">Call-to-Action Link</h4>
                           <label className="block text-sm font-medium text-gray-300 mb-1">Button Text (Optional)</label>
                           <input
                               type="text"
                               value={currentNode.buttonText || ''}
                               onChange={(e) => updateNode('buttonText', e.target.value)}
                               className="w-full p-2 border border-gray-600 bg-gray-800 text-gray-100 rounded-md focus:ring-teal-500 focus:border-teal-500"
                               placeholder="e.g., Download My Plan"
                           />
                           <label className="block text-sm font-medium text-gray-300 mt-4 mb-1">Button URL (Must start with http:// or https://)</label>
                           <input
                               type="url"
                               value={currentNode.buttonUrl || ''}
                               onChange={(e) => updateNode('buttonUrl', e.target.value)}
                               className="w-full p-2 border border-gray-600 bg-gray-800 text-gray-100 rounded-md focus:ring-teal-500 focus:border-teal-500"
                               placeholder="https://yourproduct.com"
                           />
                       </>
                   ) : (
                       <>
                           <label className="block text-sm font-medium text-gray-300 mb-1">Question Text</label>
                           <textarea
                               value={currentNode.text}
                               onChange={(e) => updateNode('text', e.target.value)}
                               rows="3"
                               className="w-full p-2 border border-gray-600 bg-gray-800 text-gray-100 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                           />


                           <h4 className="text-base font-semibold text-gray-300 mt-6 mb-3 flex items-center justify-between">
                               Options & Logic
                               <ActionButton onClick={addOption} className="bg-indigo-700 text-white hover:bg-indigo-600 p-2 text-xs" icon={Plus}>Add Option</ActionButton>
                           </h4>


                           <div className="space-y-4">
                               {currentNode.options.map((option, index) => (
                                   <div key={option.id} className="p-3 border border-indigo-700 rounded-md bg-gray-800 shadow-sm space-y-2">
                                       <div className="flex items-start">
                                           <input
                                               type="text"
                                               placeholder={`Option ${index + 1} Text`}
                                               value={option.text}
                                               onChange={(e) => handleOptionChange(index, 'text', e.target.value)}
                                               className="w-full p-2 text-sm border border-gray-600 bg-gray-900 text-gray-100 rounded-md mr-2"
                                           />
                                           <button onClick={() => removeOption(index)} className="p-2 text-red-400 hover:text-red-500 rounded-full transition"><X className="w-4 h-4" /></button>
                                       </div>


                                       <label className="block text-xs font-medium text-gray-400">Next Step (Question or Result)</label>
                                       <select
                                           value={option.next}
                                           onChange={(e) => handleOptionChange(index, 'next', e.target.value)}
                                           className="w-full p-2 border border-gray-600 bg-gray-900 text-gray-100 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500"
                                       >
                                           <option value="" disabled>Select a target...</option>
                                           {Object.keys(availableNodes).map(id => (
                                               <option key={id} value={id}>
                                                   {availableNodes[id].type === 'question' ? 'Q: ' : 'R: '}
                                                   {availableNodes[id].title} ({id})
                                               </option>
                                           ))}
                                       </select>
                                   </div>
                               ))}
                           </div>
                       </>
                   )}
           </div>
           </div>
       );
   };


   return (
       <div className="flex flex-col md:flex-row h-full min-h-[700px] bg-gray-800 rounded-xl shadow-2xl overflow-hidden">
           <div className="w-full md:w-64 p-4 bg-gray-900 border-r border-gray-700 overflow-y-auto">
               <div className="mb-6 space-y-3">
                   <h2 className="text-xl font-bold text-gray-100">Quiz Map</h2>
                   
                   <label className="block text-xs font-bold uppercase tracking-wider text-gray-400">Quiz Title</label>
                   <input
                       type="text"
                       value={quizData.title}
                       onChange={updateQuizTitle}
                       className="w-full p-2 border border-gray-600 rounded-md text-sm bg-gray-800 text-gray-100 focus:ring-indigo-500"
                       placeholder="Quiz Title"
                   />


                   {/* NEW: Description Input */}
                   <label className="block text-xs font-bold uppercase tracking-wider text-gray-400 mt-4">Quiz Description</label>
                   <textarea
                       value={quizData.description}
                       onChange={(e) => setQuizData(prev => ({ ...prev, description: e.target.value }))}
                       rows="3"
                       className="w-full p-2 border border-gray-600 rounded-md text-sm bg-gray-800 text-gray-100 focus:ring-indigo-500"
                       placeholder="A short description for the welcome screen."
                   />


                   {/* NEW: Logo URL Input */}
                   <label className="block text-xs font-bold uppercase tracking-wider text-gray-400 mt-4">Logo URL (Optional)</label>
                   <input
                       type="url"
                       value={quizData.logoUrl}
                       onChange={(e) => setQuizData(prev => ({ ...prev, logoUrl: e.target.value }))}
                       className="w-full p-2 border border-gray-600 rounded-md text-sm bg-gray-800 text-gray-100 focus:ring-indigo-500"
                       placeholder="https://example.com/logo.png"
                   />




                   <label className="block text-xs font-bold uppercase tracking-wider text-gray-400 mt-4">Starting Question</label>
                   <select
                       value={quizData.startId}
                       onChange={updateStartId}
                       className="w-full p-2 border border-gray-600 rounded-md text-sm bg-gray-800 text-gray-100 focus:ring-indigo-500"
                   >
                       <option value="" disabled>Select start point...</option>
                       {Object.keys(quizData.questions).map(id => (
                           <option key={id} value={id}>
                               {quizData.questions[id].text} ({id})
                           </option>
                       ))}
                   </select>
               </div>


               <div className="space-y-6">
                   {renderNodeList(quizData.questions, "Questions", 'question')}
                   {renderNodeList(quizData.results, "Results", 'result')}
               </div>
               
               <div className="mt-8 pt-4 border-t border-gray-700 space-y-3">
                    <ActionButton
                        onClick={() => setShowColorPanel(p => !p)}
                        className={`w-full text-white ${showColorPanel ? 'bg-orange-600 hover:bg-orange-500' : 'bg-orange-700 hover:bg-orange-600'}`}
                        icon={Palette}
                    >
                        {showColorPanel ? 'Hide Colors' : 'Edit Colors'}
                    </ActionButton>
                    <ActionButton
                        onClick={() => setEditorMode('export')}
                        className="w-full bg-teal-800 text-white hover:bg-teal-700"
                        icon={Code}
                    >
                        Export Embed HTML
                    </ActionButton>
               </div>
           </div>


           <div className="flex-1 p-6 md:p-8 overflow-y-auto">
               {showColorPanel ? (
                   <CustomizationPanel quizData={quizData} setQuizData={setQuizData} />
               ) : (
                   <>
                       <h3 className="text-2xl font-bold text-indigo-400 mb-6 border-b pb-2 border-gray-700">
                           Editing: {isResultNode ? 'Result' : 'Question'} ({selectedId})
                       </h3>
                       {renderNodeDetails()}
                   </>
               )}
           </div>
       </div>
   );
};


// Export Code Component
const ExportCode = ({ quizData, setEditorMode }) => {
   const [copyStatus, setCopyStatus] = useState('Copy Code');
   const { bgColor, textColor, primaryColor, primaryHover, accentColor } = quizData.colors;


   const generateEmbeddableHtml = (data) => {
       const { colors, ...playerData } = data;
       const quizJson = JSON.stringify(playerData).replace(/</g, '\\u003c').replace(/>/g, '\\u003e');
       const uniqueId = Date.now();
       
       return `<!-- Interactive Quiz Blueprint: Embeddable Player (HTML/CSS/JS - WordPress Ready) -->
<!-- Copy and paste this entire code block into your WordPress page (use the "Custom HTML" or "Code" block) -->
<div id="quiz-root-${uniqueId}" class="quiz-container">
   <style>
       .quiz-container {
           font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
           padding: 24px;
           max-width: 540px;
           margin: 0 auto;
       }
       .quiz-card {
           padding: 2rem;
           background-color: ${bgColor};
           border: 1px solid ${accentColor};
           border-radius: 0.75rem;
           box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
           transition: all 0.3s ease;
       }
       .quiz-question-text {
           color: ${textColor};
           font-size: 1.5rem;
           font-weight: 700;
           margin-bottom: 1.5rem;
       }
       .quiz-option-button {
           display: flex;
           align-items: center;
           justify-content: center;
           width: 100%;
           padding: 1rem;
           margin-top: 0.75rem;
           background-color: ${primaryColor};
           color: ${textColor};
           font-weight: 600;
           border-radius: 0.5rem;
           transition: background-color 0.2s, transform 0.1s;
           cursor: pointer;
           border: none;
       }
       .quiz-option-button:hover {
           background-color: ${primaryHover};
       }
       .quiz-result-title {
           color: ${accentColor};
           font-size: 2rem;
           font-weight: 800;
           margin-bottom: 1rem;
           border-bottom: 2px solid ${accentColor};
           padding-bottom: 0.5rem;
       }
       .quiz-result-content, .quiz-result-content p, .quiz-result-content ul {
           color: ${textColor};
           white-space: pre-wrap;
           margin-bottom: 2rem;
           line-height: 1.6;
       }
       .quiz-cta-button {
           display: flex;
           align-items: center;
           justify-content: center;
           width: 100%;
           padding: 1rem;
           background-color: ${accentColor};
           color: ${bgColor};
           font-size: 1.125rem;
           font-weight: 700;
           border-radius: 0.5rem;
           transition: background-color 0.3s, box-shadow 0.3s;
           text-decoration: none;
           box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
       }
       .quiz-cta-button:hover {
           filter: brightness(1.1);
       }
       .quiz-reset-button {
           display: block;
           width: 100%;
           padding: 0.75rem;
           margin-top: 1rem;
           background-color: ${primaryColor};
           color: ${textColor};
           font-weight: 600;
           border-radius: 0.5rem;
           text-align: center;
           cursor: pointer;
           border: none;
       }
       .quiz-reset-button:hover {
           background-color: ${primaryHover};
       }
       /* New Intro Screen Styles */
       .quiz-logo {
           width: 96px;
           height: 96px;
           object-fit: contain;
           margin: 0 auto 1.5rem;
           border-radius: 0.5rem;
       }
       .quiz-title-intro {
           font-size: 2.25rem;
           font-weight: 800;
           margin-bottom: 0.75rem;
           text-align: center;
       }
       .quiz-description-intro {
           font-size: 1.125rem;
           line-height: 1.6;
           margin-bottom: 2rem;
           text-align: center;
       }
       .quiz-start-button {
           display: flex;
           align-items: center;
           justify-content: center;
           width: 100%;
           padding: 1rem;
           font-size: 1.25rem;
           font-weight: 700;
           border-radius: 0.5rem;
           transition: background-color 0.2s, transform 0.1s;
           cursor: pointer;
           border: none;
           background-color: ${accentColor};
           color: ${bgColor};
       }
       .quiz-start-button:hover {
           filter: brightness(1.1);
       }
       .quiz-name-input {
           width: 100%;
           padding: 0.75rem;
           margin-bottom: 1.5rem;
           border: 1px solid #4B5563;
           background-color: #1F2937;
           color: #F3F4F6;
           border-radius: 0.5rem;
           outline: none;
           transition: border-color 0.2s;
       }
   </style>


   <script>
       document.addEventListener('DOMContentLoaded', function() {
           const QUIZ_DATA = ${quizJson};
           const ROOT_ID = 'quiz-root-${uniqueId}';
           const rootElement = document.getElementById(ROOT_ID);
           if (!rootElement) return;


           let quizState = 'intro'; // 'intro', 'quiz', 'result'
           let currentId = QUIZ_DATA.startId;
           let answers = [];
           let userName = '';


           const availableNodes = {
                ...Object.keys(QUIZ_DATA.questions).reduce((acc, id) => { acc[id] = { type: 'question', title: QUIZ_DATA.questions[id].text }; return acc; }, {}),
                ...Object.keys(QUIZ_DATA.results).reduce((acc, id) => { acc[id] = { type: 'result', title: QUIZ_DATA.results[id].title }; return acc; }, {})
           };


           function handleReset() {
               quizState = 'intro';
               currentId = QUIZ_DATA.startId;
               answers = [];
               userName = '';
               render();
           }


           function handleStartQuiz() {
               const nameInput = document.getElementById(\`user-name-input-\${uniqueId}\`);
               userName = nameInput.value.trim();
               quizState = 'quiz';
               render();
           }


           function handleOptionClick(button, nextId) {
               if (currentId.startsWith('r')) return;
               
               answers.push({ qId: currentId, optionId: button.getAttribute('data-id') || 'untracked', next: nextId });
               currentId = nextId;


               if (nextId.startsWith('r')) {
                   quizState = 'result';
               }
               render();
           }


           function renderIntro() {
               const logoHtml = QUIZ_DATA.logoUrl ? \`<img src="\${QUIZ_DATA.logoUrl}" alt="Quiz Logo" class="quiz-logo" onerror="this.style.display='none'">\` : '';
               
               rootElement.innerHTML = \`
                   <div class="quiz-card" style="border-color: ${primaryColor};">
                       \${logoHtml}
                       <h2 class="quiz-title-intro" style="color: ${primaryColor};">\${QUIZ_DATA.title}</h2>
                       <p class="quiz-description-intro" style="color: ${textColor};">\${QUIZ_DATA.description}</p>
                       
                       <div style="margin-top: 1.5rem;">
                           <label for="user-name-input-\${uniqueId}" style="display: block; font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; color: ${accentColor};">Your Name (Optional but encouraged):</label>
                           <input type="text" id="user-name-input-\${uniqueId}" placeholder="Enter your name" class="quiz-name-input">
                       </div>


                       <button class="quiz-start-button" id="quiz-start-\${uniqueId}">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                           Start Quiz
                       </button>
                   </div>
               \`;
               
               document.getElementById(\`quiz-start-\${uniqueId}\`).addEventListener('click', handleStartQuiz);
           }
           
           function renderResult(currentNode) {
               let answerList = answers.map((ans) => {
                   const question = QUIZ_DATA.questions[ans.qId];
                   const option = question?.options.find(opt => opt.id === ans.optionId);
                   return \`<li><span style="font-weight:600;">\${question?.text || 'Unknown Question'}</span>: \${option?.text || 'Unknown Answer'}</li>\`;
               }).join('');


               const userGreeting = userName ? \`<h3 style="color: ${primaryColor}; font-size: 1.125rem; font-weight: 700; margin-bottom: 1rem;">Hello, \${userName}!</h3>\` : '';


               rootElement.innerHTML = \`
                   <div class="quiz-card" style="border-color: ${accentColor};">
                       \${userGreeting}
                       <h2 class="quiz-result-title">\${currentNode.title}</h2>
                       <p class="quiz-result-content">\${currentNode.content}</p>
                       
                       <h3 style="color:${accentColor}; font-weight:600; margin-bottom:0.5rem;">Your Journey:</h3>
                       <ul class="quiz-result-content" style="list-style: disc; margin-left: 20px;">\${answerList}</ul>


                       \${currentNode.buttonUrl && currentNode.buttonText ? \`
                           <a href="\${currentNode.buttonUrl}" target="_blank" rel="noopener noreferrer" class="quiz-cta-button">
                               <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><polyline points="9 18 15 12 9 6"></polyline></svg>
                               \${currentNode.buttonText}
                           </a>
                       \` : ''}
                       <button class="quiz-reset-button" id="quiz-reset-\${uniqueId}">Start New Quiz</button>
                   </div>
               \`;
               
               document.getElementById(\`quiz-reset-\${uniqueId}\`).addEventListener('click', handleReset);
           }
           
           function renderQuestion(currentNode) {
               let optionsHtml = currentNode.options.map(option => {
                   const targetType = availableNodes[option.next]?.type === 'result' ? 'R' : 'Q';
                   return \`
                       <button class="quiz-option-button" data-next="\${option.next}" data-id="\${option.id}">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><polyline points="9 18 15 12 9 6"></polyline></svg>
                           \${option.text}
                           <span style="margin-left: auto; font-size: 0.75rem; opacity: 0.8;"> (\${targetType}) </span>
                       </button>
                   \`;
               }).join('');


               rootElement.innerHTML = \`
                   <div class="quiz-card" style="border-color: ${primaryColor};">
                       <h2 class="quiz-question-text">\${currentNode.text}</h2>
                       <div>\${optionsHtml}</div>
                   </div>
               \`;


               rootElement.querySelectorAll('.quiz-option-button').forEach(button => {
                   button.addEventListener('click', function() {
                       handleOptionClick(this, this.getAttribute('data-next'));
                   });
               });
           }
           
           function render() {
               if (quizState === 'intro') {
                   renderIntro();
                   return;
               }


               const currentNode = QUIZ_DATA.questions[currentId] || QUIZ_DATA.results[currentId];
               if (!currentNode) {
                   rootElement.innerHTML = \`<div class="quiz-card"><p style="color:red;">Error: Missing node \${currentId}</p></div>\`;
                   return;
               }


               if (currentId.startsWith('r')) {
                   renderResult(currentNode);
               } else {
                   renderQuestion(currentNode);
               }
           }


           window.quizReset_${uniqueId} = handleReset; // Expose reset function for developer use


           render();
       });
   </script>
</div>
<!-- End Interactive Quiz Blueprint Embed -->`;
   };


   const handleCopy = () => {
       const code = generateEmbeddableHtml(quizData);
       try {
           if (navigator.clipboard) {
                navigator.clipboard.writeText(code).then(() => {
                   setCopyStatus('Copied!');
                   setTimeout(() => setCopyStatus('Copy Code'), 2000);
                });
           } else {
               const textarea = document.createElement('textarea');
               textarea.value = code;
               document.body.appendChild(textarea);
               textarea.select();
               document.execCommand('copy');
               document.body.removeChild(textarea);
               
               setCopyStatus('Copied!');
               setTimeout(() => setCopyStatus('Copy Code'), 2000);
           }
       } catch (err) {
           console.error('Failed to copy text: ', err);
           setCopyStatus('Error Copying!');
           setTimeout(() => setCopyStatus('Copy Code'), 3000);
       }
   };
   
   const embedCode = generateEmbeddableHtml(quizData);


   return (
       <div className="p-8 bg-gray-800 rounded-xl shadow-2xl border border-gray-700">
           <h3 className="text-2xl font-bold text-teal-400 mb-6 border-b pb-2 border-gray-700 flex items-center">
               <Code className="w-6 h-6 mr-3" />
               Embeddable HTML Code
           </h3>
           <p className="text-gray-300 mb-4">
               This is the **full, self-contained HTML code** you requested. Just copy and paste this entire block into a **Custom HTML** block on your WordPress page.
           </p>
           
           <div className="relative">
               <pre className="bg-gray-900 p-4 rounded-lg text-sm text-green-300 overflow-x-auto max-h-[500px] border border-gray-700">
                   <code>{embedCode}</code>
               </pre>
               <ActionButton
                   onClick={handleCopy}
                   className={`absolute top-4 right-4 text-white ${copyStatus === 'Copied!' ? 'bg-green-600 hover:bg-green-500' : 'bg-indigo-600 hover:bg-indigo-500'}`}
                   icon={Clipboard}
               >
                   {copyStatus}
               </ActionButton>
           </div>
           
           <div className="mt-6 text-center">
                <ActionButton
                   onClick={() => setEditorMode('builder')}
                   className="bg-gray-700 text-gray-100 hover:bg-gray-600"
                   icon={Settings}
               >
                   Back to Builder Mode
               </ActionButton>
           </div>
       </div>
   );
};


// Main App Component
const App = () => {
   const [editorMode, setEditorMode] = useState('builder');
   const [quizData, setQuizData] = useState(INITIAL_QUIZ_DATA);
   const [saveStatus, setSaveStatus] = useState('Ready');


   // Function to save data, with fallback to localStorage
   const saveQuizData = useCallback(async (data) => {
       setSaveStatus('Saving...');
       const dataString = JSON.stringify(data);
       try {
           // Attempt to use window.storage if available (for Canvas environment)
           if (window.storage && window.storage.set) {
               await window.storage.set('quiz-data', dataString);
           } else {
               // Fallback to standard browser localStorage
               localStorage.setItem('quiz-data', dataString);
           }
           setSaveStatus('Saved!');
           setTimeout(() => setSaveStatus('Ready'), 2000);
       } catch (error) {
           console.error("Error saving:", error);
           setSaveStatus('Save Failed!');
           setTimeout(() => setSaveStatus('Error'), 3000);
       }
   }, []);


   const debouncedSave = useDebounce(saveQuizData, 1000);


   useEffect(() => {
       const loadData = async () => {
           try {
               let storedData = null;
               
               // Attempt to load from window.storage first
               if (window.storage && window.storage.get) {
                   const result = await window.storage.get('quiz-data');
                   if (result && result.value) {
                       storedData = result.value;
                   }
               } else {
                   // Fallback to standard browser localStorage
                   storedData = localStorage.getItem('quiz-data');
               }


               if (storedData) {
                   const data = JSON.parse(storedData);
                   // Merge with defaults to ensure all keys are present
                   const mergedData = {
                       ...INITIAL_QUIZ_DATA,
                       ...data,
                       colors: {
                           ...INITIAL_COLORS,
                           ...(data.colors || {})
                       }
                   };
                   setQuizData(mergedData);
               }
           } catch (error) {
               console.log("No valid saved data found or JSON parse error, using defaults:", error);
           }
       };
       loadData();
   }, []);


   useEffect(() => {
       debouncedSave(quizData);
   }, [quizData, debouncedSave]);


   const availableNodes = useMemo(() => {
       if (!quizData) return {};
       const qNodes = Object.keys(quizData.questions).reduce((acc, id) => {
           acc[id] = { title: quizData.questions[id].text, type: 'question' };
           return acc;
       }, {});
       const rNodes = Object.keys(quizData.results).reduce((acc, id) => {
           acc[id] = { title: quizData.results[id].title, type: 'result' };
           return acc;
       }, {});
       return { ...qNodes, ...rNodes };
   }, [quizData]);


   const renderContent = () => {
       if (editorMode === 'builder') {
           return (
               <QuizBuilder
                   quizData={quizData}
                   setQuizData={setQuizData}
                   availableNodes={availableNodes}
                   setEditorMode={setEditorMode}
               />
           );
       }
       if (editorMode === 'player') {
           return (
               <div className="flex flex-col items-center pt-12">
                   <h2 className="text-3xl font-bold text-gray-100 mb-8 border-b-4 border-teal-500 pb-2">{quizData.title}</h2>
                   <QuizPlayer
                       quizData={quizData}
                       onReset={() => setEditorMode('builder')}
                       availableNodes={availableNodes}
                   />
               </div>
           );
       }
       if (editorMode === 'export') {
           return (
               <ExportCode
                   quizData={quizData}
                   setEditorMode={setEditorMode}
               />
           );
       }
       return null;
   };


   return (
       <div className="min-h-screen bg-gray-900 p-4 sm:p-6 font-sans text-gray-100">
           <div className="mb-4 flex justify-between items-center p-3 bg-gray-800 rounded-xl shadow-lg border border-gray-700">
               <h1 className="text-xl font-extrabold text-gray-100 flex items-center">
                   <Send className="w-6 h-6 mr-3 text-indigo-400" />
                   Quiz Blueprint Tool
               </h1>
               <div className="flex items-center space-x-3">
                   <span className={`text-sm font-medium ${saveStatus === 'Saved!' ? 'text-green-400' : saveStatus.includes('Failed') ? 'text-red-400' : 'text-gray-400'}`}>
                       <Save className="inline w-4 h-4 mr-1"/> {saveStatus}
                   </span>
                   <ActionButton
                       onClick={() => setEditorMode(editorMode === 'builder' ? 'player' : 'builder')}
                       className={`text-white transition-all ${editorMode === 'builder' ? 'bg-teal-500 hover:bg-teal-600' : 'bg-indigo-500 hover:bg-indigo-600'}`}
                       icon={editorMode === 'builder' ? Play : Settings}
                   >
                       Switch to {editorMode === 'builder' ? 'Player' : 'Builder'} Mode
                   </ActionButton>
               </div>
           </div>
           
           {renderContent()}
       </div>
   );
};


export default App;

