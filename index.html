<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiz Blueprint Tool - Standalone</title>
  <meta name="description" content="Standalone Quiz Builder, Player, and Export - self-contained" />
  <style>
    /* Minimal UI styles (kept as-is from previous build) */
    :root { --bg:#0f1724; --card:#0b1220; --muted:#9fb6bc; --accent:#10b981; --primary:#06b6d4; --primary-hover:#0891b2; --text:#e6eef8; }
    html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;color:var(--text);}
    #quiz-builder-root { padding:18px; max-width:1200px; margin:20px auto; }
    .qb-app { display:flex; gap:16px; background:linear-gradient(180deg,#071022,#071428); border-radius:12px; border:1px solid #0f1724; padding:18px; box-sizing:border-box; }
    .qb-sidebar { width:320px; background:var(--card); padding:14px; border-radius:10px; border:1px solid #111827; box-sizing:border-box; }
    .qb-main { flex:1; background:linear-gradient(180deg,#071022,#071428); padding:16px; border-radius:10px; min-height:560px; border:1px solid #0f1724; box-sizing:border-box; }
    .qb-title { font-weight:800; font-size:18px; color:#9df0d7; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .qb-section { margin-top:12px; }
    input[type="text"], input[type="url"], textarea, select {
      width:100%; padding:8px; background:#061226; border:1px solid #1f2937; color:var(--text); border-radius:6px; box-sizing:border-box;
    }
    button { cursor:pointer; border: none; padding:8px 10px; border-radius:8px; background:var(--primary); color:#071022; font-weight:700; }
    .ghost { background:transparent; border:1px dashed #2b3945; color:#cbd5e1; padding:6px 8px; }
    .list-item { display:flex; align-items:center; justify-content:space-between; padding:8px; border-radius:8px; background:#071022; margin-bottom:8px; border:1px solid #111827; color:#cfe9e6; }
    .small { font-size:13px; color:#9fb6bc; }
    .options-list { margin-top:8px; }
    .option-row { display:flex; gap:8px; margin-bottom:8px; }
    .color-row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .preview-area { max-width:640px; margin:0 auto; }
    pre { background:#041024; padding:12px; color:#9fe0c9; border-radius:8px; overflow:auto; max-height:420px; }
    .flex { display:flex; gap:8px; align-items:center; }
    .muted { color:#8aa0a6; font-size:13px; }
    .danger { background:#ef4444; color:#fff; }
    .inline-btn { padding:6px 8px; border-radius:6px; background:#1f2937; color:#dbeafe; border:1px solid #111827; cursor:pointer; }
    label { font-size:13px; color:#9fb6bc; display:block; margin-bottom:6px; }
    .quiz-embed { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; padding:20px; max-width:640px; margin:0 auto; }
  </style>
</head>
<body>
  <div id="quiz-builder-root"></div>

  <script>
  (function(){
    // ---------- INITIAL DATA ----------
    const DEFAULT_COLORS = {
      bgColor: '#0b1220',
      textColor: '#e6eef8',
      primaryColor: '#06b6d4',
      primaryHover: '#0891b2',
      accentColor: '#10b981'
    };

    const INITIAL = {
      title: "Untitled Transformation Quiz",
      description: "Discover your personalized plan by answering a few quick questions.",
      logoUrl: "",
      startId: "q1",
      colors: {...DEFAULT_COLORS},
      questions: {
        "q1": { text: "What is your current fitness level?", options: [
          { id: "o1", text: "Beginner", next: "q2" },
          { id: "o2", text: "Intermediate", next: "q2" },
          { id: "o3", text: "Advanced", next: "r_pro" }
        ]},
        "q2": { text: "How many hours a week can you dedicate to training?", options: [
          { id: "o4", text: "1-3 hours (Casual)", next: "r_low_effort" },
          { id: "o5", text: "4-6 hours (Moderate)", next: "r_medium" }
        ]}
      },
      results: {
        "r_low_effort": { title: "Your Sustainable Plan", content: "Focus on consistency and diet first. We recommend two 30-minute sessions per week.", buttonText:"Get My Quick Start Guide", buttonUrl:"https://example.com/quick-start" },
        "r_medium": { title: "Your Intermediate Plan", content: "You are ready for a 4-day split routine focusing on progressive overload.", buttonText:"See Intermediate Products", buttonUrl:"https://example.com/products/intermediate" },
        "r_pro": { title: "Your Advanced Optimization Plan", content: "We will refine your current routine with periodization and specific recovery techniques.", buttonText:"Book a Consultation", buttonUrl:"https://example.com/consultation" }
      }
    };

    // ---------- STORAGE ----------
    const STORAGE_KEY = 'qb-standalone-data-v1';
    function loadState(){
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return JSON.parse(JSON.stringify(INITIAL));
        const parsed = JSON.parse(raw);
        const merged = {...INITIAL, ...parsed, colors: {...DEFAULT_COLORS, ...(parsed.colors||{})}, questions: {...INITIAL.questions, ...(parsed.questions||{})}, results: {...INITIAL.results, ...(parsed.results||{})}};
        if(!merged.startId || (!merged.questions[merged.startId] && !merged.results[merged.startId])) merged.startId = Object.keys(merged.questions)[0] || '';
        return merged;
      } catch(e){
        console.error(e);
        return JSON.parse(JSON.stringify(INITIAL));
      }
    }
    function saveState(state){
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch(e){
        console.error('Failed saving', e);
      }
    }

    // ---------- STATE ----------
    let state = loadState();
    let selectedId = state.startId || Object.keys(state.questions)[0];

    // ---------- DOM ROOT ----------
    const root = document.getElementById('quiz-builder-root');

    // ---------- HELPERS ----------
    function uid(prefix='id'){ return prefix + Math.random().toString(36).slice(2,9); }
    function isResult(id){ return id && id.startsWith('r'); }
    function availableNodesForSelect(){
      const out = [];
      for(const id of Object.keys(state.questions)) out.push({ id, label: 'Q: ' + (state.questions[id].text||id) });
      for(const id of Object.keys(state.results)) out.push({ id, label: 'R: ' + (state.results[id].title||id) });
      return out;
    }

    // ---------- RENDER ----------
    function render(){
      saveState(state);
      root.innerHTML = '';
      const app = document.createElement('div');
      app.className = 'qb-app';

      // Sidebar
      const sidebar = document.createElement('div');
      sidebar.className = 'qb-sidebar';
      sidebar.innerHTML = `
        <div class="qb-title">Quiz Builder <span class="small muted">vanilla</span></div>

        <div class="qb-section">
          <label>Title</label>
          <input id="sb-title" type="text" value="${escapeHtml(state.title)}" />
          <label style="margin-top:8px;">Description</label>
          <textarea id="sb-desc" rows="3">${escapeHtml(state.description)}</textarea>
          <label style="margin-top:8px;">Logo URL (optional)</label>
          <input id="sb-logo" type="url" value="${escapeHtml(state.logoUrl)}" />
          <label style="margin-top:8px;">Start Node</label>
          <select id="sb-start"></select>
        </div>

        <div class="qb-section">
          <label class="small">Questions</label>
          <div id="list-questions"></div>
          <button id="add-question" style="margin-top:8px;" class="inline-btn">+ Add Question</button>
        </div>

        <div class="qb-section">
          <label class="small">Results</label>
          <div id="list-results"></div>
          <button id="add-result" style="margin-top:8px;" class="inline-btn">+ Add Result</button>
        </div>

        <div class="qb-section">
          <label class="small">Colors</label>
          <div class="color-row"><input id="c-bg" type="color" value="${state.colors.bgColor}" /> <input id="c-bg-t" type="text" value="${state.colors.bgColor}" /></div>
          <div class="color-row"><input id="c-text" type="color" value="${state.colors.textColor}" /> <input id="c-text-t" type="text" value="${state.colors.textColor}" /></div>
          <div class="color-row"><input id="c-primary" type="color" value="${state.colors.primaryColor}" /> <input id="c-primary-t" type="text" value="${state.colors.primaryColor}" /></div>
          <div class="color-row"><input id="c-primary-hover" type="color" value="${state.colors.primaryHover}" /> <input id="c-primary-hover-t" type="text" value="${state.colors.primaryHover}" /></div>
          <div class="color-row"><input id="c-accent" type="color" value="${state.colors.accentColor}" /> <input id="c-accent-t" type="text" value="${state.colors.accentColor}" /></div>
        </div>

        <div class="qb-section">
          <div class="flex" style="justify-content:space-between;">
            <button id="to-player" class="inline-btn">Preview Player</button>
            <button id="to-export" class="inline-btn">Export Embed</button>
          </div>
          <div style="margin-top:10px;"><button id="reset-data" class="danger">Reset to Defaults</button></div>
        </div>
      `;

      // fill lists
      app.appendChild(sidebar);

      const main = document.createElement('div');
      main.className = 'qb-main';
      main.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div style="font-size:18px; font-weight:800; color:#9df0d7;">Editing: <span id="editing-label">${escapeHtml(selectedId||'')}</span></div>
            <div class="muted" style="margin-top:6px;">Edit the selected node below. Click items in the lists to pick them.</div>
          </div>
          <div style="display:flex; gap:8px;">
            <button id="save-now" class="inline-btn">Save</button>
            <button id="switch-player" class="inline-btn">Open Player</button>
          </div>
        </div>

        <div id="editor-pane" style="margin-top:12px;"></div>

        <div id="preview-pane" style="margin-top:18px;"></div>
      `;

      app.appendChild(main);

      root.appendChild(app);

      // populate start select
      const startSelect = sidebar.querySelector('#sb-start');
      startSelect.innerHTML = '';
      availableNodesForSelect().forEach(n => {
        const opt = document.createElement('option');
        opt.value = n.id;
        opt.textContent = `${n.label} (${n.id})`;
        if(n.id === state.startId) opt.selected = true;
        startSelect.appendChild(opt);
      });

      // populate question/result lists
      const qList = sidebar.querySelector('#list-questions');
      qList.innerHTML = '';
      for(const id of Object.keys(state.questions)){
        const el = document.createElement('div');
        el.className = 'list-item';
        el.innerHTML = `<div style="max-width:190px"><strong>${escapeHtml(state.questions[id].text||id)}</strong><div class="small muted">${id}</div></div>
                        <div style="display:flex; gap:6px;">
                          <button class="inline-btn select-q" data-id="${id}">Edit</button>
                          <button class="inline-btn remove-q" data-id="${id}">Del</button>
                        </div>`;
        qList.appendChild(el);
      }
      const rList = sidebar.querySelector('#list-results');
      rList.innerHTML = '';
      for(const id of Object.keys(state.results)){
        const el = document.createElement('div');
        el.className = 'list-item';
        el.innerHTML = `<div style="max-width:190px"><strong>${escapeHtml(state.results[id].title||id)}</strong><div class="small muted">${id}</div></div>
                        <div style="display:flex; gap:6px;">
                          <button class="inline-btn select-r" data-id="${id}">Edit</button>
                          <button class="inline-btn remove-r" data-id="${id}">Del</button>
                        </div>`;
        rList.appendChild(el);
      }

      // ---------- HOOKS ----------
      // sidebar inputs
      sidebar.querySelector('#sb-title').addEventListener('input', e=>{ state.title = e.target.value; saveState(state); });
      sidebar.querySelector('#sb-desc').addEventListener('input', e=>{ state.description = e.target.value; saveState(state); });
      sidebar.querySelector('#sb-logo').addEventListener('input', e=>{ state.logoUrl = e.target.value; saveState(state); });
      startSelect.addEventListener('change', e=>{ state.startId = e.target.value; saveState(state); });

      // color inputs binding
      function bindColor(idColor, idText, key){
        const c = sidebar.querySelector(idColor);
        const t = sidebar.querySelector(idText);
        c.addEventListener('input', e=>{ state.colors[key]=e.target.value; t.value=e.target.value; renderEditor(); saveState(state); });
        t.addEventListener('input', e=>{ state.colors[key]=e.target.value; c.value=e.target.value; renderEditor(); saveState(state); });
      }
      bindColor('#c-bg','#c-bg-t','bgColor');
      bindColor('#c-text','#c-text-t','textColor');
      bindColor('#c-primary','#c-primary-t','primaryColor');
      bindColor('#c-primary-hover','#c-primary-hover-t','primaryHover');
      bindColor('#c-accent','#c-accent-t','accentColor');

      // add question/result buttons
      sidebar.querySelector('#add-question').addEventListener('click', ()=>{
        const id = uid('q');
        state.questions[id] = { text: 'New Question', options: [{ id: uid('o'), text:'Option A', next: state.startId || Object.keys(state.questions)[0] || Object.keys(state.results)[0] || '' }] };
        selectedId = id;
        render();
        renderEditor();
      });
      sidebar.querySelector('#add-result').addEventListener('click', ()=>{
        const id = uid('r');
        state.results[id] = { title: 'New Result', content: 'Result content...', buttonText:'', buttonUrl:'' };
        selectedId = id;
        render();
        renderEditor();
      });

      // delete handlers
      qList.querySelectorAll('.remove-q').forEach(btn=> btn.addEventListener('click', (ev)=>{
        const id = ev.currentTarget.dataset.id;
        delete state.questions[id];
        Object.values(state.questions).forEach(q => q.options = q.options.map(o => o.next===id ? state.startId : o));
        if(selectedId===id) selectedId = Object.keys(state.questions)[0] || Object.keys(state.results)[0] || '';
        render();
        renderEditor();
      }));
      rList.querySelectorAll('.remove-r').forEach(btn=> btn.addEventListener('click', (ev)=>{
        const id = ev.currentTarget.dataset.id;
        delete state.results[id];
        Object.values(state.questions).forEach(q => q.options = q.options.map(o => o.next===id ? state.startId : o));
        if(selectedId===id) selectedId = Object.keys(state.questions)[0] || Object.keys(state.results)[0] || '';
        render();
        renderEditor();
      }));

      // edit selection handlers
      qList.querySelectorAll('.select-q').forEach(btn=> btn.addEventListener('click', (ev)=>{
        selectedId = ev.currentTarget.dataset.id;
        document.getElementById('editing-label').textContent = selectedId;
        renderEditor();
      }));
      rList.querySelectorAll('.select-r').forEach(btn=> btn.addEventListener('click', (ev)=>{
        selectedId = ev.currentTarget.dataset.id;
        document.getElementById('editing-label').textContent = selectedId;
        renderEditor();
      }));

      // reset
      sidebar.querySelector('#reset-data').addEventListener('click', ()=>{
        if(!confirm('Reset quiz to defaults? This will overwrite current data.')) return;
        state = JSON.parse(JSON.stringify(INITIAL));
        selectedId = state.startId;
        saveState(state);
        render();
        renderEditor();
      });

      // quick Save
      main.querySelector('#save-now').addEventListener('click', ()=>{ saveState(state); alert('Saved locally'); });

      // switch to player preview
      main.querySelector('#switch-player').addEventListener('click', ()=>{ renderPlayerModal(); });

      // Preview and Export buttons
      sidebar.querySelector('#to-player').addEventListener('click', ()=>{ renderPlayerModal(); });
      sidebar.querySelector('#to-export').addEventListener('click', ()=>{ renderExport(); });

      // initial editor render
      renderEditor();
    } // end render()

    // ---------- Editor Pane ----------
    function renderEditor(){
      const editor = document.querySelector('#editor-pane');
      const previewPane = document.querySelector('#preview-pane');
      if(!editor) return;
      editor.innerHTML = '';
      previewPane.innerHTML = '';

      // selected node
      if(!selectedId){
        editor.innerHTML = `<div class="muted">No node selected. Create a question or result to begin.</div>`;
        return;
      }

      if(isResult(selectedId)){
        const r = state.results[selectedId];
        if(!r) { editor.innerHTML = `<div class="muted">Missing result data.</div>`; return; }
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
          <label>Result ID</label>
          <div class="small muted">${selectedId}</div>
          <label style="margin-top:8px;">Title</label>
          <input id="res-title" type="text" value="${escapeHtml(r.title||'')}" />
          <label style="margin-top:8px;">Content</label>
          <textarea id="res-content" rows="6">${escapeHtml(r.content||'')}</textarea>
          <label style="margin-top:8px;">Button Text (optional)</label>
          <input id="res-button-text" type="text" value="${escapeHtml(r.buttonText||'')}" />
          <label style="margin-top:8px;">Button URL (optional)</label>
          <input id="res-button-url" type="url" value="${escapeHtml(r.buttonUrl||'')}" />
        `;
        editor.appendChild(wrapper);

        wrapper.querySelector('#res-title').addEventListener('input', e=>{ r.title = e.target.value; saveState(state); render(); });
        wrapper.querySelector('#res-content').addEventListener('input', e=>{ r.content = e.target.value; saveState(state); });
        wrapper.querySelector('#res-button-text').addEventListener('input', e=>{ r.buttonText = e.target.value; saveState(state); });
        wrapper.querySelector('#res-button-url').addEventListener('input', e=>{ r.buttonUrl = e.target.value; saveState(state); });

      } else {
        const q = state.questions[selectedId];
        if(!q) { editor.innerHTML = `<div class="muted">Missing question data.</div>`; return; }
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
          <label>Question ID</label>
          <div class="small muted">${selectedId}</div>
          <label style="margin-top:8px;">Question Text</label>
          <textarea id="q-text" rows="3">${escapeHtml(q.text||'')}</textarea>
          <div style="margin-top:12px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div class="small muted">Options & Logic</div>
              <button id="add-opt" class="inline-btn">+ Option</button>
            </div>
            <div id="opts" class="options-list"></div>
          </div>
        `;
        editor.appendChild(wrapper);

        wrapper.querySelector('#q-text').addEventListener('input', e=>{ q.text = e.target.value; saveState(state); render(); });

        const optsEl = wrapper.querySelector('#opts');
        function renderOptions(){
          optsEl.innerHTML = '';
          q.options.forEach((opt, idx) => {
            const row = document.createElement('div');
            row.className = 'option-row';
            row.innerHTML = `
              <input class="opt-text" data-idx="${idx}" type="text" value="${escapeHtml(opt.text||'')}" />
              <select class="opt-next" data-idx="${idx}"></select>
              <button class="inline-btn remove-opt" data-idx="${idx}">Del</button>
            `;
            optsEl.appendChild(row);

            // fill select
            const sel = row.querySelector('.opt-next');
            const nodes = availableNodesForSelect();
            nodes.forEach(n=> {
              const o = document.createElement('option'); o.value = n.id; o.textContent = `${n.label} (${n.id})`; if(n.id === opt.next) o.selected = true;
              sel.appendChild(o);
            });

            // handlers
            row.querySelector('.opt-text').addEventListener('input', e=>{ q.options[idx].text = e.target.value; saveState(state); render(); });
            sel.addEventListener('change', e=>{ q.options[idx].next = e.target.value; saveState(state); });
            row.querySelector('.remove-opt').addEventListener('click', ()=>{
              q.options.splice(idx,1);
              if(q.options.length===0) q.options.push({ id: uid('o'), text:'New Option', next: state.startId || Object.keys(state.questions)[0] || '' });
              saveState(state); render();
              renderEditor();
            });
          });
        }
        renderOptions();

        wrapper.querySelector('#add-opt').addEventListener('click', ()=>{
          q.options.push({ id: uid('o'), text: 'New Option', next: state.startId || Object.keys(state.questions)[0] || '' });
          saveState(state); renderEditor();
        });
      }

      // small live preview of the selected node
      const previewPane = document.querySelector('#preview-pane');
      previewPane.innerHTML = '<div style="opacity:0.9; padding:8px; border-radius:8px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.02)"><div class="small muted">Live preview (player view) below:</div></div>';
      const previewArea = document.createElement('div');
      previewArea.className = 'preview-area';
      previewArea.style.marginTop = '12px';
      previewArea.innerHTML = generatePlayerHtmlFragment(state, selectedId);
      previewPane.appendChild(previewArea);

      // attach small player behavior for the preview (initialize)
      initializePlayer(null, state);
    }

    // ---------- Player Modal / Inline Player ----------
    function renderPlayerModal(){
      const previewPane = document.querySelector('#preview-pane');
      previewPane.innerHTML = '';
      const container = document.createElement('div');
      container.style.padding = '10px';
      container.style.borderRadius = '8px';
      container.style.background = 'linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005))';
      container.style.border = '1px solid rgba(255,255,255,0.02)';

      const title = document.createElement('div'); title.innerHTML = `<div style="font-weight:800; color:#9df0d7">Player Preview</div><div class="muted small">Interact with the quiz as a visitor would.</div>`;
      container.appendChild(title);

      const playerWrapper = document.createElement('div');
      playerWrapper.style.marginTop = '12px';
      playerWrapper.innerHTML = generatePlayerHtmlFragment(state);
      container.appendChild(playerWrapper);

      previewPane.appendChild(container);

      // activate player script
      initializePlayer(container.querySelector('.quiz-embed'), state);
    }

    // ---------- Export ----------
    function renderExport(){
      const previewPane = document.querySelector('#preview-pane');
      previewPane.innerHTML = '';
      const wrap = document.createElement('div');
      wrap.innerHTML = `<div style="font-weight:800; color:#9df0d7">Export Embed Code</div><div class="muted small" style="margin-top:6px">Copy the entire code block into a WordPress Custom HTML block.</div>`;
      const code = generateEmbeddableHtml(state);
      const pre = document.createElement('pre');
      pre.textContent = code;
      wrap.appendChild(pre);
      const copyBtn = document.createElement('button');
      copyBtn.textContent = 'Copy Code';
      copyBtn.style.marginTop = '8px';
      copyBtn.addEventListener('click', ()=>{
        navigator.clipboard.writeText(code).then(()=>{ copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent='Copy Code', 1600); });
      });
      wrap.appendChild(copyBtn);
      previewPane.appendChild(wrap);
    }

    // ---------- EMBED GENERATOR ----------
    function generateEmbeddableHtml(data){
      const c = data.colors || DEFAULT_COLORS;
      const playerData = JSON.parse(JSON.stringify(data)); // safe copy
      const playerJson = JSON.stringify(playerData).replace(/</g,'\\u003c').replace(/>/g,'\\u003e');
      const uniqueId = Date.now();
      return `<!-- Quiz Embed (self-contained) -->
<div id="quiz-root-${uniqueId}" class="quiz-embed"></div>
<style>
.quiz-embed { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; padding:20px; max-width:640px; margin:0 auto; }
.quiz-card { padding:20px; background:${c.bgColor}; border-radius:12px; border:1px solid ${c.accentColor}; }
.quiz-title { color:${c.primaryColor}; font-weight:800; font-size:22px; margin-bottom:8px; }
.quiz-desc { color:${c.textColor}; margin-bottom:16px; }
.quiz-option { display:flex; align-items:center; justify-content:center; padding:12px; margin-top:8px; background:${c.primaryColor}; color:${c.textColor}; border-radius:10px; cursor:pointer; border:none; width:100%; font-weight:700; }
.quiz-option:hover { background:${c.primaryHover}; }
.quiz-cta { display:block; padding:12px; margin-top:12px; background:${c.accentColor}; color:${c.bgColor}; text-align:center; text-decoration:none; border-radius:10px; font-weight:800; }
.quiz-reset { display:block; padding:10px; margin-top:10px; background:${c.primaryColor}; color:${c.textColor}; text-align:center; border-radius:8px; cursor:pointer; border:none; }
</style>
<script>
(function(){
  const DATA = ${playerJson};
  const ROOT = document.getElementById('quiz-root-${uniqueId}');
  if(!ROOT) return;
  let state='intro', current = DATA.startId, answers=[];
  function render(){
    if(state==='intro'){
      ROOT.innerHTML = '<div class="quiz-card">'
        + (DATA.logoUrl?('<img src="'+DATA.logoUrl+'" style="width:96px;height:96px;object-fit:contain;margin:0 auto 12px;border-radius:8px;" onerror="this.style.display=\\'none\\'">'):'')
        + '<div class="quiz-title">'+escapeHtml(DATA.title)+'</div>'
        + '<div class="quiz-desc">'+escapeHtml(DATA.description)+'</div>'
        + '<input id="user_name_input" placeholder="Your name (optional)" style="width:100%;padding:10px;margin-bottom:12px;border-radius:8px;border:1px solid #374151;background:#0b1220;color:#e6eef8;">'
        + '<button id="startBtn" class="quiz-option" style="background:${c.accentColor}; color:${c.bgColor};">Start Quiz</button>'
        + '</div>';
      const b = document.getElementById('startBtn');
      b && b.addEventListener('click', ()=>{ state='quiz'; current = DATA.startId; answers=[]; render(); });
      return;
    }
    const node = DATA.questions[current] || DATA.results[current];
    if(!node){ ROOT.innerHTML='<div class="quiz-card"><p style="color:red;">Error: missing node '+current+'</p></div>'; return; }
    if(current.startsWith('r')){
      // result
      ROOT.innerHTML = '<div class="quiz-card">'
        + (document.getElementById('user_name_input') && document.getElementById('user_name_input').value ? '<div style="color:${c.primaryColor};font-weight:700;margin-bottom:8px;">Hello, '+escapeHtml(document.getElementById('user_name_input').value)+'</div>' : '')
        + '<div class="quiz-title">'+escapeHtml(node.title)+'</div>'
        + '<div style="color:${c.textColor}">'+escapeHtml(node.content).replace(/\\n/g,'<br>')+'</div>'
        + (node.buttonUrl && node.buttonText?('<a class="quiz-cta" href="'+node.buttonUrl+'" target="_blank" rel="noopener noreferrer">'+escapeHtml(node.buttonText)+'</a>'):'')
        + '<button id="resetBtn" class="quiz-reset">Start New Quiz</button>'
        + '</div>';
      const rb = document.getElementById('resetBtn'); rb && rb.addEventListener('click', ()=>{ state='intro'; current=DATA.startId; answers=[]; render(); });
      return;
    }
    // question
    ROOT.innerHTML = '<div class="quiz-card"><div class="quiz-title" style="font-size:18px;color:${c.textColor}">'+escapeHtml(node.text)+'</div><div id="opts_wrap"></div></div>';
    const wrap = document.getElementById('opts_wrap');
    node.options.forEach(opt=>{
      const btn = document.createElement('button');
      btn.className = 'quiz-option';
      btn.style.background='${c.primaryColor}';
      btn.innerText = opt.text + (opt.next && opt.next.startsWith('r') ? ' (Result)' : '');
      btn.addEventListener('click', ()=>{
        answers.push({ qId: current, optionId: opt.id });
        current = opt.next;
        if(current && current.startsWith('r')){ state='result'; }
        render();
      });
      wrap.appendChild(btn);
    });
  }
  // escapeHtml for result safety inside embed
  function escapeHtml(s){ if(!s) return ''; return s.toString().replace(/[&<>"]/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]; }); }
  render();
})();
</script>
<!-- End Quiz Embed -->`;
    }

    // ---------- PLAYER FRAGMENT FOR EDITOR PREVIEW ----------
    function generatePlayerHtmlFragment(data, forceNodeId){
      const c = data.colors || DEFAULT_COLORS;
      const payload = { data: data, forceNodeId: forceNodeId || null, colors: c };
      return `<div class="quiz-embed" style="border-radius:10px; padding:12px;" data-payload='${escapeHtml(JSON.stringify(payload))}'>
        <div style="text-align:center; color:${c.primaryColor}; font-weight:800;">${escapeHtml(data.title)}</div>
        <div style="color:${c.textColor}; margin-top:8px;">${escapeHtml(data.description)}</div>
        <div style="margin-top:12px;"><small class="muted">Preview â€” click below to open full preview</small></div>
      </div>
      <div style="margin-top:8px;"><button class="inline-btn" id="openFullPreview">Open Full Preview</button></div>`;
    }

    // ---------- PLAYER INITIALIZER (for preview pane) ----------
    function initializePlayer(container, data){
      if(!container) {
        const embed = document.querySelector('.quiz-embed');
        if(!embed) return;
        const payload = JSON.parse(embed.dataset.payload || '{}');
        const payloadData = payload.data || data;
        runStandalonePlayer(embed, payloadData, payload.forceNodeId || null);
        const btn = document.getElementById('openFullPreview');
        if(btn) btn.addEventListener('click', ()=>{ renderPlayerModal(); });
      } else {
        const embed = container.querySelector('.quiz-embed');
        if(!embed) return;
        const payload = JSON.parse(embed.dataset.payload || '{}');
        runStandalonePlayer(embed, payload.data || data, payload.forceNodeId || null);
      }
    }

    function runStandalonePlayer(rootEl, DATA, forceNode){
      rootEl.innerHTML = '';
      const c = DATA.colors || DEFAULT_COLORS;
      const card = document.createElement('div'); card.className='quiz-card'; card.style.background=c.bgColor; card.style.border='1px solid '+c.accentColor; card.style.padding='12px';
      rootEl.appendChild(card);
      let state='intro', current = forceNode || DATA.startId, answers=[];
      function render(){
        card.innerHTML = '';
        if(state==='intro'){
          if(DATA.logoUrl){ const img=document.createElement('img'); img.src=DATA.logoUrl; img.style.width='72px'; img.style.height='72px'; img.style.objectFit='contain'; img.style.display='block'; img.style.margin='0 auto 8px'; img.onerror=function(){ this.style.display='none'; }; card.appendChild(img); }
          const t = document.createElement('div'); t.style.color=c.primaryColor; t.style.fontWeight=800; t.style.fontSize='18px'; t.textContent=DATA.title; card.appendChild(t);
          const d = document.createElement('div'); d.style.color=c.textColor; d.style.marginTop='8px'; d.textContent=DATA.description; card.appendChild(d);
          const start = document.createElement('button'); start.className='quiz-option'; start.textContent='Start Quiz'; start.style.background=c.accentColor; start.style.color=c.bgColor; start.style.marginTop='12px';
          start.addEventListener('click', ()=>{ state='quiz'; current=DATA.startId; answers=[]; render(); });
          card.appendChild(start);
          return;
        }
        const node = DATA.questions[current] || DATA.results[current];
        if(!node) { card.innerHTML='<div style="color:red">Missing node '+current+'</div>'; return; }
        if(current.startsWith('r')){
          const t = document.createElement('div'); t.style.color=c.accentColor; t.style.fontWeight=800; t.style.fontSize='18px'; t.textContent=node.title; card.appendChild(t);
          const p = document.createElement('div'); p.style.color=c.textColor; p.style.marginTop='8px'; p.innerHTML = (node.content||'').replace(/\\n/g,'<br>');
          card.appendChild(p);
          if(node.buttonUrl && node.buttonText){
            const a = document.createElement('a'); a.href=node.buttonUrl; a.target='_blank'; a.className='quiz-cta'; a.textContent=node.buttonText; a.style.background=c.accentColor; a.style.color=c.bgColor; a.style.display='block'; a.style.marginTop='12px';
            card.appendChild(a);
          }
          const reset = document.createElement('button'); reset.className='quiz-reset'; reset.textContent='Start New Quiz'; reset.style.marginTop='12px'; reset.addEventListener('click', ()=>{ state='intro'; current=DATA.startId; answers=[]; render(); });
          card.appendChild(reset);
          return;
        }
        const q = document.createElement('div'); q.style.color=c.textColor; q.style.fontWeight=700; q.textContent=node.text; card.appendChild(q);
        node.options.forEach(opt=>{
          const b = document.createElement('button'); b.className='quiz-option'; b.textContent=opt.text; b.style.background=c.primaryColor; b.style.color=c.textColor; b.style.marginTop='8px';
          b.addEventListener('click', ()=>{ answers.push({ qId: current, optionId: opt.id }); current=opt.next; if(current && current.startsWith('r')) state='result'; render(); });
          card.appendChild(b);
        });
      }
      render();
    }

    // ---------- UTIL ----------
    function escapeHtml(s){ if(s===undefined || s===null) return ''; return s.toString().replace(/[&<>"]/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]; }); }

    // initial render
    render();

    // try hooking up preview clicks
    document.addEventListener('click', function(e){
      if(e.target && e.target.id === 'openFullPreview'){ renderPlayerModal(); }
      if(e.target && e.target.matches && e.target.matches('.quiz-embed') ){
        // noop
      }
    });

  })(); // IIFE end
  </script>
</body>
</html>
